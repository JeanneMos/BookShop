"use strict";(self.webpackChunkespace_souvenir=self.webpackChunkespace_souvenir||[]).push([[487],{1972:function(e,t,a){a.r(t),a.d(t,{default:function(){return o}});var s=a(885),n=a(7294),r=a(5998),l=a(2816),c=a(1295),i=a(1887),m=a(4243),u=n.lazy((function(){return Promise.all([a.e(154),a.e(5),a.e(170)]).then(a.bind(a,6719))}));function o(){var e=(0,n.useState)(!1),t=(0,s.Z)(e,2),a=t[0],o=t[1],d=(0,n.useState)(!1),g=(0,s.Z)(d,2),p=g[0],f=g[1],v=(0,n.useRef)(),E=(0,n.useRef)(),h=(0,r.v9)((function(e){return e.messages}));return a?n.createElement(u,{closeForm:function(e){var t=e.messageSent;f(t),o(!1)},reference:v}):n.createElement(n.Fragment,null,p&&n.createElement("p",{className:"message-status mb-40"},n.createElement(c.default,{name:"check",iconClass:"message-status-icon"}),n.createElement("span",null,"Votre message a bien été ajouté")),n.createElement("div",{className:"heading-button-wrapper between"},n.createElement("h2",{className:"content-heading-2",ref:E},n.createElement("span",null,"Messages")," ",null!=h&&h.messagesNumber&&(null==h?void 0:h.messagesNumber)>0?n.createElement(m.Z,{number:null==h?void 0:h.messagesNumber}):null),n.createElement(l.Z,{type:"button",btnClass:"bg-current",onClickAction:function(){o(!0)}},n.createElement("span",{className:"button-text"},"Ecrire un message"),n.createElement("span",{className:"separator"}," "),n.createElement(c.default,{name:"next",iconClass:"white-icon"}))),n.createElement(i.Z,null))}},1887:function(e,t,a){a.d(t,{Z:function(){return A}});var s=a(4942),n=a(885),r=a(7294),l=a(5998),c=a(6974),i=a(2849),m=a(4470),u=a(1628),o=a(1295),d=a(6578);function g(){return r.createElement("div",{className:"messages-wrapper"},r.createElement("p",{className:"messages-empty-text","data-testid":"emptyMessageList"},"Il n'y a pas encore de messages sur cet Espace Souvenirs"))}var p=a(4184),f=a.n(p),v=a(1935),E=a(324),h=a(5320),b=a(2816),N=a(8954);function y(e){var t=e.email,a=e.subject,s=a?"?subject=".concat(a):null;return r.createElement(N.Z,{as:"ahref",linkTo:"mailto:".concat(t).concat(s),linkClass:"link bg-transparent"},r.createElement(o.default,{name:"envelope",iconClass:"current-icon envelope-icon"}),r.createElement("span",{className:"separator"}," "),r.createElement("span",{className:"link-text"},"Répondre"))}function _(e){var t=e.isLoading,a=e.handleSwitch,s=e.messageId,n=e.isChecked;return r.createElement("div",{className:f()("switch-wrapper",t&&"loading-status")},r.createElement("span",null,n?"Publié":"Dépublié"),r.createElement("label",{className:"switch","data-testid":"switchCheck"},r.createElement("input",{disabled:t,type:"checkbox",checked:n,onChange:function(){a(s)}}),r.createElement("span",{className:"slider"})))}function w(){return r.createElement("span",{className:"new-message-tag"},"nouveau")}var Z=r.memo((function(e){var t,a,s=e.message,c=s.field_message_surname,m=s.field_message_name,u=s.field_message_date_created,o=s.field_message_texte,d=s.field_message_email,g=s.field_message_photo,p=s.field_message_status,N=s.field_message_banner,Z=s.isNew,C=s.message_id,k=(0,l.v9)((function(e){return e.globalInfo})),O=(0,l.v9)((function(e){return e.administrator})),j=(0,h.Z)(),S=(0,r.useState)(!1),A=(0,n.Z)(S,2),P=A[0],Q=A[1],I=(0,r.useState)(p),x=(0,n.Z)(I,2),L=x[0],T=x[1],M=(0,r.useRef)(null),D=(0,r.useRef)(null),F=(0,r.useMemo)((function(){if(u)return(0,E.NE)((0,E.eQ)(u))}),[u]),R="Merci pour votre message en hommage à ".concat((0,E.lF)(null==k||null===(t=k.defunt)||void 0===t?void 0:t.firstName)||""," ").concat(null==k||null===(a=k.defunt)||void 0===a?void 0:a.lastName);return(0,r.useEffect)((function(){M.current&&D.current&&(M.current.clientHeight>D.current.clientHeight?Q(!1):Q(!0))}),[]),r.createElement("li",{className:f()("message-item",{"message-item-long":g||N})},Z&&r.createElement(w,null),g&&r.createElement("div",{className:"message-item-image-wrapper"},r.createElement("img",{alt:"",className:"message-item-image",loading:"lazy",src:function(e){return"string"==typeof e?e[0]:e[0].url}(g)})),N&&r.createElement("div",{className:"message-item-image-wrapper"},r.createElement("img",{alt:"",className:"message-item-image",loading:"lazy",src:function(e){return"".concat(window.location.origin,"/themes/custom/souvenirs/src/assets/images/bg-images/").concat(e)}(N)})),r.createElement("div",{className:f()("message-author",{"mt-50":!g,"mt-20":g})},r.createElement("p",{"data-testid":"writtenby-message"},"Ecrit par ",r.createElement("span",{className:"info-firstname"},m)," ",r.createElement("span",{className:"info-lastname"},c)),r.createElement("p",null,F)),o&&r.createElement("div",{ref:D,className:f()("message-body",{open:P})},r.createElement("p",{ref:M},(0,E.SQ)(o))),!P&&r.createElement(v.Z,null,r.createElement(b.Z,{type:"button",onClickAction:function(){Q(!0)},btnClass:"bg-transparent"},"Lire la suite",r.createElement("span",{className:"sr-only"},"du message envoyé par ",m," ",c))),(null==O?void 0:O.isAdmin)&&r.createElement(v.Z,{position:"space-between"},r.createElement(_,{isLoading:j.isLoading,handleSwitch:function(){var e={field_value:!L,field_machine_name:i.C_,message_id:C};try{j.mutate({data:e,apiUrl:i.A8},{onSuccess:function(e){var t=e.data;T(null==t?void 0:t.field_value)}})}catch(e){T(p)}},messageId:u,isChecked:L}),r.createElement(y,{email:d,subject:R})))})),C=a(2982),k=a(8767);function O(e){var t=e.messages,a=(0,l.I0)(),s=((0,k.useQueryClient)(),(0,l.v9)((function(e){return e.messages}))),c=s.messagesViewed.length?s.messagesViewed:(0,E.yQ)(t,0,i.BN),u=(0,r.useState)(c),d=(0,n.Z)(u,2),g=d[0],p=d[1];return r.createElement("div",{className:"messages-wrapper"},r.createElement("ul",{className:"messages-list","data-testid":"messagesWithPaginationList"},g.map((function(e){return r.createElement(Z,{key:null==e?void 0:e.message_id,message:e})}))),r.createElement("p",{className:"messages-number-view"},r.createElement("label",{htmlFor:"messages-progress"},"Vous avez vu ",g.length," messages sur ",t.length),r.createElement("progress",{id:"messages-progress",className:"messages-progress",max:t.length,value:g.length})),t.length>g.length&&r.createElement(v.Z,{position:"center",btnWrapperClass:"mt-30"},r.createElement(b.Z,{type:"button",btnClass:"bg-white",onClickAction:function(){var e=g.length,s=e+i.BN,n=[].concat((0,C.Z)(g),(0,C.Z)((0,E.yQ)(t,e,s)));p(n),a((0,m.Po)({messagesViewed:n}))}},r.createElement("span",{className:"button-text"},"voir plus de messages"),r.createElement("span",{className:"separator"}," "),r.createElement(o.default,{name:"next",iconClass:"current-icon"}))))}function j(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,s)}return a}function S(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?j(Object(a),!0).forEach((function(t){(0,s.Z)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):j(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function A(e){var t=e.page,a=(0,r.useState)(!1),s=(0,n.Z)(a,2),p=s[0],f=s[1],v=(0,l.v9)((function(e){return e.administrator})),E=(0,c.UO)().espaceId,h=(0,l.I0)(),b=t===i.Qv?"".concat(i.JT,"?entity_hash=").concat(E,"&msg_number=2"):"".concat(i.JT,"?entity_hash=").concat(E),N=t===i.Qv?i.hZ:i.Qy,y=(0,u.Z)({key:N,API:b,staleTime:v.isAdmin?500:5e4,cacheTime:v.isAdmin?0:i.Qd,refetchOnMount:v.isAdmin}),_=y.data,w=y.error,C=y.isFetching,k=(0,u.Z)({key:i.Qo,API:"".concat(i.Y_,"?entity_hash=").concat(E),staleTime:0,cacheTime:0,enabled:v.isAdmin}).data;if((0,r.useEffect)((function(){return v.isAdmin&&h((0,m.sf)({messagesNumber:+(null==k?void 0:k.new_message_number)})),null!=_&&_.error&&f(!0),function(){t!==i.Qv&&v.isAdmin&&h((0,m.sf)({messagesNumber:0}))}}),[k]),C)return r.createElement(d.Z,null);if(w||p)return r.createElement("div",{className:"messages-wrapper"},r.createElement("p",{className:"message-status"},r.createElement(o.default,{name:"cross",iconClass:"message-status-icon error-icon"}),r.createElement("span",null,"Une erreur s'est produite. Nous vous invitons à réessayer plus tard.")));if(_&&null!=_&&_.result){var j,A=_.result,P=null!=v&&v.isAdmin?A.map((function(e){return S(S({},e),{},{isNew:1e3*(null==_?void 0:_.msg_date_last_consult)<1e3*+e.field_message_date_created})})):A;return P&&P.length>8?r.createElement(O,{messages:P}):0===(null==_||null===(j=_.result)||void 0===j?void 0:j.length)||0===(null==P?void 0:P.length)?r.createElement(g,null):r.createElement("div",{className:"messages-wrapper"},r.createElement("ul",{className:"messages-list","data-testid":"messagesList"},P.map((function(e){return r.createElement(Z,{key:null==e?void 0:e.message_id,message:e})}))))}return r.createElement("div",{className:"messages-wrapper"},r.createElement(d.Z,null))}},1935:function(e,t,a){a.d(t,{Z:function(){return l}});var s=a(4184),n=a.n(s),r=a(7294);function l(e){var t=e.position,a=e.children,s=e.btnWrapperClass;return r.createElement("div",{className:n()("buttons-wrapper",t,s)},a)}},5320:function(e,t,a){var s=a(9669),n=a.n(s),r=(a(7294),a(8767)),l={headers:{"Content-Type":"application/json"},withCredentials:!0,credentials:"include"};t.Z=function(e){var t=(0,r.useMutation)((function(t){var a=t.data,s=t.apiUrl,r=t.options,c=void 0===r?e||l:r;return n().post(s,a,c)})),a=t.data,s=t.error,c=(t.isError,t.isIdle,t.isLoading),i=(t.isPaused,t.isSuccess),m=t.mutate;t.mutateAsync,t.reset,t.status;return{mutate:m,isSuccess:i,data:a,isLoading:c,error:s}}}}]);